<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Mini App - Poin Reward</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">Aplikasi Poin Reward</h1>
    <div id="user-info" class="mb-4 text-center"></div>
    <div id="points-display" class="text-lg font-semibold mb-4 text-center">Poin: 0</div>
    <button id="watch-ad" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Tonton Iklan (+1 Poin)</button>
    <div id="message" class="mt-4 text-center text-red-500"></div>
  </div>

  <script>
    // Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Ambil data pengguna Telegram
    const user = tg.initDataUnsafe.user;
    if (user) {
      console.log('Pengguna terdeteksi:', user);
      document.getElementById('user-info').innerText = `Selamat datang, ${user.first_name}!`;
      loadMonetagScript();
      loadLocalPoints(user.id);
    } else {
      console.error('Tidak ada data pengguna Telegram');
      document.getElementById('message').innerText = 'Buka aplikasi ini dari Telegram.';
    }

    // Muat skrip Monetag secara dinamis
    function loadMonetagScript() {
      if (window.show_9244919) {
        console.log('Skrip Monetag sudah dimuat');
        return;
      }
      console.log('Memuat skrip Monetag');
      const tag = document.createElement('script');
      tag.src = '//whephiwums.com/sdk.js';
      tag.dataset.zone = '9244919';
      tag.dataset.sdk = 'show_9244919';
      tag.onload = () => console.log('Skrip Monetag dimuat');
      tag.onerror = () => console.error('Gagal memuat skrip Monetag');
      document.body.appendChild(tag);
    }

    // Muat poin dari localStorage
    function loadLocalPoints(telegramId) {
      try {
        const userData = JSON.parse(localStorage.getItem(`user_${telegramId}`)) || { telegramId, points: 0 };
        console.log('Poin dimuat dari localStorage:', userData);
        document.getElementById('points-display').innerText = `Poin: ${userData.points}`;
        return userData;
      } catch (error) {
        console.error('Error saat memuat localStorage:', error);
        return { telegramId, points: 0 };
      }
    }

    // Simpan poin ke localStorage
    function saveLocalPoints(telegramId, points) {
      try {
        const userData = { telegramId, points };
        localStorage.setItem(`user_${telegramId}`, JSON.stringify(userData));
        console.log('Poin disimpan ke localStorage:', userData);
        document.getElementById('points-display').innerText = `Poin: ${userData.points}`;
      } catch (error) {
        console.error('Error saat menyimpan ke localStorage:', error);
        document.getElementById('message').innerText = 'Gagal menyimpan poin ke localStorage.';
      }
    }

    // Update poin ke channel
    async function updateCloudPoints(telegramId, points) {
      try {
        console.log(`Mengirim ke cloud: telegramId: ${telegramId}, points: ${points}`);
        const response = await fetch('/.netlify/functions/updatePoints', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegramId, points })
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`Gagal memanggil /updatePoints: Status ${response.status}, ${errorText}`);
          throw new Error(`Request failed with status code ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        console.log('Cloud diperbarui:', data);
        return data;
      } catch (error) {
        console.error('Error saat update cloud:', error);
        throw error;
      }
    }

    async function watchAd() {
      try {
        console.log('Tombol Tonton Iklan diklik');
        
        // Validasi aksi menonton iklan
        const validateResponse = await fetch('/.netlify/functions/validateAdWatch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegramId: user.id })
        });

        if (!validateResponse.ok) {
          const errorText = await validateResponse.text();
          throw new Error(`Validasi gagal dengan status ${validateResponse.status}: ${errorText}`);
        }

        const validateData = await validateResponse.json();
        if (validateData.error) {
          throw new Error(validateData.error);
        }

        console.log('Validasi iklan berhasil');

        // Tampilkan iklan Monetag
        if (window.show_9244919) {
          console.log('Memulai iklan Monetag');
          await new Promise((resolve, reject) => {
            show_9244919().then(() => {
              console.log('Iklan selesai');
              resolve();
            }).catch((error) => {
              console.error('Error iklan:', error);
              reject(new Error('Gagal menampilkan iklan.'));
            });
          });

          // Tambah poin setelah iklan selesai
          const localData = loadLocalPoints(user.id);
          const newPoints = localData.points + 1;
          
          // Simpan ke localStorage terlebih dahulu
          saveLocalPoints(user.id, newPoints);
          
          // Kemudian update ke cloud
          await updateCloudPoints(user.id, newPoints);
          
          document.getElementById('message').innerText = 'Iklan ditonton! +1 Poin';
          return;
        }

        console.error('Skrip Monetag belum dimuat');
        throw new Error('Skrip iklan belum dimuat. Coba lagi.');

      } catch (error) {
        console.error('Error saat tonton iklan:', error);
        document.getElementById('message').innerText = `Error: ${error.message}`;
      }
    }

    document.getElementById('watch-ad').addEventListener('click', watchAd);
  </script>
</body>
</html>